
<script>

var form=new ControlForm({
    'view'            : view,
    'class'           : 'ticket.Tickets',
    'get_params'      : view.params,
    'on_change'       : 'put',
    'title'           : 'View task {title}',
    'favorite_menu'   : 'ticket',
    'context'         : '.ticket',
    'create_view_params': view.params,
    'get_result': function(result)
    {
        $(".on-click-new-ticket-note", context).click(function()
        {
            viewCreate({ creator: context },
            {
                name: 'ticket.TicketObjects.edit',
                mode: 'main',
                params: {
                    ticket_id: view.params._id,
                    type: 'note'

                }
            });

        });

        $(".on-click-new-ticket-time", context).on('click',".field-list-item", function()
        {
            viewCreate({ creator: context },
            {
                name: 'ticket.TicketObjects.edit',
                mode: 'main',
                params: {
                    ticket_id: view.params._id,
                    type: 'time',
                    billing_relation: $(this).attr("field-list-id")
                }
            });

        });

        $(".on-click-ticket-list", context).click(function()
        {
            viewCreate({ clear:true, creator: context },
            {
                name: 'ticket.Tickets.list',
                mode: 'main',
                params: {}
            });

        });
    }
});



new ControlList({
    'view'              : view,
    'context'           : '.ticket-objects',
    'class'             : 'ticket.TicketObjects',
    'endless_scrolling' : true,
    'get'               : 'ticket.TicketObjects.get_all_by_ticket',
    'get_params'        : { 'ticket_id': view.params._id },
    'on_change'         : 'get',

});

new ControlListRelated({
    'view'              : view,
    'context'           : '.ticket-depends',
    'class'             : 'ticket.Tickets',
    'endless_scrolling' : false,
    'related_key'       : 'tickets',
    'related_value'     : view.params._id,
});

</script>


<span class='ticket'>
    <span control-view="ticket.Tickets.edit">

        <table class='inline-block'>
            <tr>
                <td class='field-meta-put control-on-click-view' field-key='ticket_completed' field-meta-key='desc'>
                <td class='field-put value control-on-click-view' field-key='ticket_completed'>
            </tr>
            <tr>
                <td class='field-meta-put control-on-click-view' field-key='title' field-meta-key='desc'>
                <td style='font-weight:bold' class='field-put value control-on-click-view' field-key='title'>
            </tr>
            <tr>
                <td class='field-meta-put control-on-click-view' field-key='desc' field-meta-key='desc'>
                <td style='white-space: pre-wrap' class='field-put value control-on-click-view' field-key='desc'>
            </tr>
            <tr>
                <td class='field-meta-put control-on-click-view nowrap' field-key='start_date' field-meta-key='desc'>
                <td class='field-put value control-on-click-view nowrap'  field-key='start_date'>
            </tr>
            <tr>
                <td class='field-meta-put control-on-click-view nowrap' field-key='due_date' field-meta-key='desc'>
                <td class='field-put value control-on-click-view nowrap'  field-key='due_date'>
            </tr>
            <tr>
                <td class='field-meta-put control-on-click-view nowrap' field-key='ticket_status' field-meta-key='desc'>
                <td class='field-put value control-on-click-view nowrap'  field-key='ticket_status'>
            </tr>
            <tr>
                <td class='field-meta-put control-on-click-view nowrap' field-key='ticket_priority' field-meta-key='desc'>
                <td class='field-put value control-on-click-view nowrap'  field-key='ticket_priority'>
            </tr>
            <tr>
                <td class='field-meta-put control-on-click-view' field-key='relations' field-meta-key='desc'>
                <td class='field-meta-put control-on-click-view' field-key='relations'>
                    <span class='list-span field-list-source field-list-source-hide' field-key='relations' field-list-view="ticket.Relations.edit">
                        <span class='field-put' field-key='relations.title'></span>
                    </span>
            </tr>
        </table>

        <fieldset class='inline-block'>
        <legend>Sharing</legend>
            <table >
                <tr class='field-meta-put control-on-click-view' field-key='owner'>
                    <td class='field-meta-put' field-key='owner' field-meta-key='desc'>
                    <td>:
                        <span class='field-list-source field-list-source-hide' field-key='owner' field-list-view="core.Users.edit">
                            <span class='list-span field-put field-list-on-click-view' field-key='owner.name'></span>
                        </span>
                </tr>

                <tr class='field-meta-put control-on-click-view' field-key='deligated_users'>
                    <td class='field-meta-put' field-key='deligated_users' field-meta-key='desc'>
                    <td>:
                        <span class='field-list-source field-list-source-hide' field-key='deligated_users' field-list-view="core.Users.edit">
                            <span class='list-span field-put field-list-on-click-view' field-key='deligated_users.name'></span>
                        </span>
                </tr>

                <tr class='field-meta-put control-on-click-view'  field-key='allowed_groups'>
                    <td class='field-meta-put' field-key='allowed_groups' field-meta-key='desc'>
                    <td>:
                        <span class='field-list-source field-list-source-hide' field-key='allowed_groups' field-list-view="core.Groups.edit">
                            <span class='list-span field-put field-list-on-click-view' field-key='allowed_groups.name'></span>
                        </span>
                </tr>
            </table>
        </fieldset>

        <fieldset class='inline-block'>
            <legend class='field-meta-put' field-key='tickets' field-meta-key='desc'></legend>
            <table class='field-meta-put field-key-root' field-key='tickets'>
                <tr class='colorRows field-list-source field-list-source-hide ui-widget-content' field-key='tickets' field-list-view="ticket.Tickets.show">
                    <td class='field-put field-list-on-click-view' field-key='tickets.ticket_status'>
                    <td class='field-put field-list-on-click-view' field-key='tickets.title'>
                </tr>
            </table>
        </fieldset>

        <div class='floatingBar viewErrorClass'>
            <button class='on-click-ticket-list' >Tasks</button>
            <button class='on-click-new-ticket-note ticket-add-note-button-style' >Add note</button>

            <span class='field-meta-put on-click-new-ticket-time' field-key='relations' >
                    <span class='field-list-source field-list-source-hide' field-key='relations'>
                        <button class='field-put ticket-add-time-button-style' field-key='relations.title' title='Add time' ></button>
                    </span>
            </span>

            <span class='viewErrorText'></span>
        </div>


    </span>
</span>


<fieldset class='ticket-depends inline-block'>
    <legend>Tasks that depend on us</legend>
    <table >
        <tr class='colorRows field-list-source field-list-source-hide ui-widget-content' field-key='' field-list-view="ticket.Tickets.show">
            <td class='field-list-on-click-view field-put' field-key='ticket_status' >
            <td class='field-list-on-click-view field-put' field-key='title' >
        </tr>
    </table>
</fieldset>




<fieldset class='ticket-objects control-hide-on-new'>
    <legend>Task history and notes</legend>
    <span class="ui-icon ui-icon-search" style='display:inline-block'></span>
    <input type='text' class='control-on-change-search control-default-focus' control-search-keys='title text'>

    <table >
        <tr class='ui-widget-header'>
            <th class='field-meta-put control-on-click-order' field-key='type' field-meta-key='desc'>
            <th class='field-meta-put control-on-click-order control-order-desc' field-key='create_time' field-meta-key='desc' >
            <th class='field-meta-put control-on-click-order' field-key='title' field-meta-key='desc'>
            <th>
        </tr>

        <tr class='colorRows ticket-object field-list-source field-list-add-after field-list-source-hide ui-widget-content' field-key='' field-list-view="ticket.TicketObjects.edit">
            <td class='field-list-on-click-view field-put' field-key='type' nowrap>
            <td class='field-list-on-click-view field-put' field-key='create_time' nowrap field-timestamp-allow-time>
            <td>
                <div class='field-list-on-click-view field-put' field-key='title' style='font-weight:bold'></div>
                <div class='field-list-on-click-view field-put' field-key='text' style='white-space: pre-wrap'></div>
        </tr>
    </table>
</fieldset>

